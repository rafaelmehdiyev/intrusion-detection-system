<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Security Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .dashboard-card {
            height: 100%;
            transition: transform 0.2s;
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        .card-threats { background: linear-gradient(45deg, #f44336, #ff5252); }
        .card-packets { background: linear-gradient(45deg, #2196f3, #64b5f6); }
        .card-blocked { background: linear-gradient(45deg, #4caf50, #81c784); }
        .card-uptime { background: linear-gradient(45deg, #ff9800, #ffb74d); }
        .event-card {
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border-left: 4px solid #ccc;
        }
        .event-card:hover {
            transform: translateX(5px);
        }
        .event-critical { border-left-color: #dc3545; }
        .event-security { border-left-color: #fd7e14; }
        .event-warning { border-left-color: #ffc107; }
        .event-dns { border-left-color: #0dcaf0; }
        .event-network { border-left-color: #0d6efd; }
        .event-system { border-left-color: #6c757d; }
        .event-info { border-left-color: #20c997; }
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .event-badges {
            display: flex;
            gap: 5px;
        }
        .event-timestamp {
            font-size: 0.85rem;
            color: #666;
        }
        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 8px;
            font-size: 0.9rem;
        }
        .event-detail {
            display: flex;
            align-items: center;
        }
        .detail-label {
            color: #666;
            margin-right: 5px;
            font-weight: 500;
        }
        .detail-value {
            color: #333;
            word-break: break-all;
        }
        .event-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #pause-events.paused {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        .event-card.new-event {
            animation: highlightNew 2s ease-out;
        }
        @keyframes highlightNew {
            0% { background-color: rgba(33, 150, 243, 0.1); }
            100% { background-color: transparent; }
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .connected { color: #4caf50; }
        .disconnected { color: #f44336; }
        .filter-tag {
            cursor: pointer;
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 15px;
            background-color: #e9ecef;
            transition: all 0.3s ease;
        }
        .filter-tag.active {
            background-color: #0d6efd;
            color: white;
        }
        .navbar {
            background: linear-gradient(45deg, #1a237e, #283593);
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        .nav-link {
            color: rgba(255,255,255,0.8) !important;
            transition: color 0.3s ease;
        }
        .nav-link:hover {
            color: white !important;
        }
        .nav-link.active {
            color: white !important;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check"></i>
                Network Security Monitor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="/">
                    <i class="bi bi-speedometer2"></i>
                    Dashboard
                </a>
                <a class="nav-link" href="/config">
                    <i class="bi bi-gear"></i>
                    Configuration
                </a>
                <a class="nav-link" href="/logs">
                    <i class="bi bi-journal-text"></i>
                    Logs
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Status Overview Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card dashboard-card stat-card card-threats text-white">
                    <div class="stat-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="stat-value" id="threatCount">0</div>
                    <div class="stat-label">Threats Detected</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card stat-card card-packets text-white">
                    <div class="stat-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="stat-value" id="packetCount">0</div>
                    <div class="stat-label">Packets Analyzed</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card stat-card card-blocked text-white">
                    <div class="stat-icon">
                        <i class="bi bi-shield-exclamation"></i>
                    </div>
                    <div class="stat-value" id="blockedCount">0</div>
                    <div class="stat-label">IPs Blocked</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card stat-card card-uptime text-white">
                    <div class="stat-icon">
                        <i class="bi bi-activity"></i>
                    </div>
                    <div class="stat-value" id="systemStatus">
                        <span id="status-indicator"></span>
                        <span id="connection-status">Connected</span>
                    </div>
                    <div class="stat-label">System Status</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Network Traffic</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trafficChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Threat Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="threatDistribution"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Event Monitor</h5>
                        <div class="event-controls">
                            <div class="filter-tags mb-2">
                                <span class="filter-tag active" data-filter="all">All</span>
                                <span class="filter-tag" data-filter="critical">Critical</span>
                                <span class="filter-tag" data-filter="security">Security</span>
                                <span class="filter-tag" data-filter="warning">Warning</span>
                                <span class="filter-tag" data-filter="dns">DNS</span>
                                <span class="filter-tag" data-filter="network">Network</span>
                                <span class="filter-tag" data-filter="system">System</span>
                                <span class="filter-tag" data-filter="info">Info</span>
                            </div>
                            <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search events...">
                            <button id="pause-events" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="bi bi-pause-fill"></i>
                            </button>
                            <button id="clear-events" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button id="exportEvents" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="bi bi-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="status-indicator" class="mb-2">
                            <span class="badge bg-success"><i class="bi bi-circle-fill"></i> Connected</span>
                            <small class="text-muted ms-2" id="event-count">0 Events</small>
                        </div>
                        <div id="events-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventsContainer = document.getElementById('events-container');
        let statusIndicator = document.getElementById('status-indicator');
        let connectionStatus = document.getElementById('connection-status');
        let filterInput = document.getElementById('searchInput');
        let eventSource = null;
        let maxEvents = 100;

        function connectEventSource() {
            // Reset counters on new connection
            document.getElementById('packetCount').innerText = '0';
            document.getElementById('threatCount').innerText = '0';
            
            eventSource = new EventSource('/events');
            
            eventSource.onopen = function() {
                statusIndicator.className = 'status-connected';
                connectionStatus.textContent = 'Connected';
            };

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addEvent(data);
                } catch (error) {
                    console.error('Error processing event:', error);
                }
            };

            eventSource.onerror = function() {
                statusIndicator.className = 'status-disconnected';
                connectionStatus.textContent = 'Disconnected - Reconnecting...';
                eventSource.close();
                setTimeout(connectEventSource, 5000);
            };

            // Get current configuration to update blocked IPs count
            fetch('/api/config', {
                credentials: 'include'  // Include credentials in the request
            })
                .then(response => response.json())
                .then(config => {
                    console.log('Fetched config:', config.IP_RULES.BLACKLISTED_IPS);
                    if (config.IP_RULES.BLACKLISTED_IPS) {
                        document.getElementById('blockedCount').innerText = config.IP_RULES.BLACKLISTED_IPS.length;
                    }
                })
                .catch(error => console.error('Error fetching config:', error));
        }

        let isPaused = false;
        let eventCount = 0;
        let pendingEvents = [];

        function updateEventCount() {
            document.getElementById('event-count').textContent = `${eventCount} Events`;
        }

        document.getElementById('pause-events').addEventListener('click', function() {
            isPaused = !isPaused;
            this.innerHTML = isPaused ? '<i class="bi bi-play-fill"></i>' : '<i class="bi bi-pause-fill"></i>';
            this.classList.toggle('paused');
            
            if (!isPaused && pendingEvents.length > 0) {
                pendingEvents.forEach(event => addEvent(event));
                pendingEvents = [];
            }
        });

        function determineEventType(content, level) {
            // 1. Critical Events (Most Important)
            if (level === 'ERROR') return 'CRITICAL';
            
            // 2. Security Events (High Priority)
            if (content.includes('blacklisted IP') || 
                content.includes('port scan') ||
                content.includes('DGA domain')) {
                return 'SECURITY';
            }
            
            // 3. Warning Events
            if (level === 'WARNING') return 'WARNING';
            
            // 4. Service-Specific Events
            if (content.includes('DNS Query')) return 'DNS';
            if (content.includes('Network Traffic')) return 'NETWORK';
            
            // 5. System Events
            if (content.includes('started') || 
                content.includes('stopped') ||
                content.includes('monitoring')) {
                return 'SYSTEM';
            }
            
            // 6. Default
            return 'INFO';
        }

        function addEvent(data) {
            if (isPaused) {
                pendingEvents.push(data);
                return;
            }

            const card = document.createElement('div');
            card.className = 'card event-card mb-2';
            
            // Extract log components
            const message = data.message;
            const match = message.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) - (\w+) - (.+)/);
            
            if (!match) return;
            
            const [_, timestamp, level, content] = match;
            const localTime = new Date(timestamp.replace(',', '.')).toLocaleTimeString();
            
            // Update dashboard stats
            updateStats(message);
            
            // Determine event type using our new function
            const eventType = determineEventType(content, level);
            card.classList.add(`event-${eventType.toLowerCase()}`);
            
            // Extract IP addresses if present
            let ipDetails = '';
            const ipMatch = content.match(/Src: ([\d\.]+), Dst: ([\d\.]+)/);
            if (ipMatch) {
                ipDetails = `
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <small class="text-muted">Source IP: </small>
                            <span class="text-primary">${ipMatch[1]}</span>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Destination IP: </small>
                            <span class="text-primary">${ipMatch[2]}</span>
                        </div>
                    </div>`;
            }
            
            // Create card content with event type badge
            card.innerHTML = `
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-${level === 'ERROR' ? 'danger' : level === 'WARNING' ? 'warning' : 'info'}">${level}</span>
                            <span class="badge bg-secondary ms-1">${eventType}</span>
                        </div>
                        <small class="text-muted">${localTime}</small>
                    </div>
                    <div class="mt-2">${content}</div>
                    ${ipDetails}
                </div>
            `;
            
            // Add to container
            eventsContainer.insertBefore(card, eventsContainer.firstChild);
            eventCount++;
            updateEventCount();
            
            // Limit number of events
            if (eventsContainer.children.length > maxEvents) {
                eventsContainer.removeChild(eventsContainer.lastChild);
            }
        }

        function updateStats(message) {
            // Parse the message
            const match = message.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) - (\w+) - (.+)/);
            
            if (!match) return;

            const [_, timestamp, level, content] = match;
            
            // Update threat count for alerts and warnings
            if (level === 'WARNING' || level === 'ERROR' || level === 'ALERT') {
                let threatCount = parseInt(document.getElementById('threatCount').innerText);
                document.getElementById('threatCount').innerText = threatCount + 1;

                // Update threat distribution chart
                let threatIndex = 3; // Default to Other (index 3)
                if (content.includes('blacklisted IP')) {
                    threatIndex = 0; // IP threats
                } else if (content.includes('port scan') || content.includes('Suspicious port')) {
                    threatIndex = 1; // Port threats
                } else if (content.includes('DNS') || content.includes('domain')) {
                    threatIndex = 2; // DNS threats
                }

                // Update the chart data
                threatDistributionChart.data.datasets[0].data[threatIndex]++;
                threatDistributionChart.update();
            }

            // Update packet count for all messages
            let packetCount = parseInt(document.getElementById('packetCount').innerText);
            document.getElementById('packetCount').innerText = packetCount + 1;
            
            // Increment packet counter for traffic chart
            packetsSinceLastUpdate++;
        }

        // Filter functionality
        const filterTags = document.querySelectorAll('.filter-tag');
        let activeFilters = ['all'];

        filterInput.addEventListener('input', applyFilters);

        filterTags.forEach(tag => {
            tag.addEventListener('click', () => {
                const filter = tag.getAttribute('data-filter');
                
                if (filter === 'all') {
                    activeFilters = ['all'];
                    filterTags.forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                } else {
                    if (activeFilters.includes('all')) {
                        activeFilters = [];
                        document.querySelector('[data-filter="all"]').classList.remove('active');
                    }
                    
                    const filterIndex = activeFilters.indexOf(filter);
                    if (filterIndex === -1) {
                        activeFilters.push(filter);
                        tag.classList.add('active');
                    } else {
                        activeFilters.splice(filterIndex, 1);
                        tag.classList.remove('active');
                    }
                    
                    if (activeFilters.length === 0) {
                        activeFilters = ['all'];
                        document.querySelector('[data-filter="all"]').classList.add('active');
                    }
                }
                
                applyFilters();
            });
        });

        function applyFilters() {
            const searchText = filterInput.value.toLowerCase();
            Array.from(eventsContainer.children).forEach(card => {
                const cardText = card.textContent.toLowerCase();
                const cardCategory = getCardCategory(card);
                
                const matchesSearch = cardText.includes(searchText);
                const matchesCategory = activeFilters.includes('all') || 
                                     activeFilters.some(filter => cardCategory.includes(filter.toLowerCase()));
                
                card.style.display = matchesSearch && matchesCategory ? '' : 'none';
            });
        }

        function getCardCategory(card) {
            const classList = card.classList;
            if (classList.contains('event-critical')) return 'critical';
            if (classList.contains('event-security')) return 'security';
            if (classList.contains('event-warning')) return 'warning';
            if (classList.contains('event-dns')) return 'dns';
            if (classList.contains('event-network')) return 'network';
            if (classList.contains('event-system')) return 'system';
            return 'info';
        }

        // Initialize charts
        const trafficCtx = document.getElementById('trafficChart').getContext('2d');
        const threatDistributionCtx = document.getElementById('threatDistribution').getContext('2d');

        // Traffic Chart
        const trafficChart = new Chart(trafficCtx, {
            type: 'line',
            data: {
                labels: Array(60).fill(''),
                datasets: [{
                    label: 'Packets/s',
                    data: Array(60).fill(0),
                    borderColor: '#2196f3',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(33, 150, 243, 0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0 // Disable animation for better performance
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Packets/second'
                        }
                    },
                    x: {
                        display: false // Hide x-axis labels for cleaner look
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Initialize packet counter and timestamp for rate calculation
        let lastUpdateTime = Date.now();
        let packetsSinceLastUpdate = 0;

        function updateTrafficChart() {
            const now = Date.now();
            const timeDiff = (now - lastUpdateTime) / 1000; // Convert to seconds
            
            if (timeDiff >= 1) { // Update every second
                const packetsPerSecond = Math.round(packetsSinceLastUpdate / timeDiff);
                
                // Shift data array and add new value
                trafficChart.data.datasets[0].data.shift();
                trafficChart.data.datasets[0].data.push(packetsPerSecond);
                
                // Update chart
                trafficChart.update('none'); // Use 'none' mode for better performance
                
                // Reset counters
                packetsSinceLastUpdate = 0;
                lastUpdateTime = now;
            }
        }

        // Set up interval to update chart
        setInterval(updateTrafficChart, 1000);

        // Initialize Threat Distribution Chart
        const threatDistributionChart = new Chart(threatDistributionCtx, {
            type: 'doughnut',
            data: {
                labels: ['IP', 'Port', 'DNS', 'Other'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        '#2962ff',  // Blue for IP
                        '#2e7d32',  // Green for Port
                        '#6f42c1',  // Purple for DNS
                        '#ed6c02'   // Orange for Other
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                return `${context.label}: ${context.raw} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        let stats = {
            threats: 0,
            packets: 0,
            blockedIPs: new Set(),
            threatTypes: {
                ip: 0,
                port: 0,
                dns: 0,
                other: 0
            },
            uniqueIPs: new Set()
        };

        // Export functionality
        document.getElementById('exportEvents').addEventListener('click', () => {
            const events = Array.from(eventsContainer.children)
                .filter(card => card.style.display !== 'none')
                .map(card => {
                    const timestamp = card.querySelector('small.text-muted').textContent;
                    const level = card.querySelector('.badge:first-child').textContent;
                    const eventType = card.querySelector('.badge.bg-secondary').textContent;
                    const content = card.querySelector('.mt-2').textContent;
                    return `${timestamp},${level},${eventType},"${content.trim()}"`;
                });
            
            const csv = ['Timestamp,Level,Type,Message', ...events].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `network_events_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });

        // Start connection
        connectEventSource();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
