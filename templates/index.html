<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Security Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .dashboard-card {
            height: 100%;
            transition: transform 0.2s;
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        .card-threats { background: linear-gradient(45deg, #f44336, #ff5252); }
        .card-packets { background: linear-gradient(45deg, #2196f3, #64b5f6); }
        .card-blocked { background: linear-gradient(45deg, #4caf50, #81c784); }
        .card-uptime { background: linear-gradient(45deg, #ff9800, #ffb74d); }
        .event-card {
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .connected { color: #4caf50; }
        .disconnected { color: #f44336; }
        .filter-tag {
            cursor: pointer;
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 15px;
            background-color: #e9ecef;
            transition: all 0.3s ease;
        }
        .filter-tag.active {
            background-color: #0d6efd;
            color: white;
        }
        .navbar {
            background: linear-gradient(45deg, #1a237e, #283593);
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        .nav-link {
            color: rgba(255,255,255,0.8) !important;
            transition: color 0.3s ease;
        }
        .nav-link:hover {
            color: white !important;
        }
        .nav-link.active {
            color: white !important;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check"></i>
                Network Security Monitor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="/">
                    <i class="bi bi-speedometer2"></i>
                    Dashboard
                </a>
                <a class="nav-link" href="/config">
                    <i class="bi bi-gear"></i>
                    Configuration
                </a>
                <a class="nav-link" href="/logs">
                    <i class="bi bi-journal-text"></i>
                    Logs
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Status Overview Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card dashboard-card stat-card card-threats text-white">
                    <div class="stat-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="stat-value" id="threatCount">0</div>
                    <div class="stat-label">Threats Detected</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card stat-card card-packets text-white">
                    <div class="stat-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="stat-value" id="packetCount">0</div>
                    <div class="stat-label">Packets Analyzed</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card stat-card card-blocked text-white">
                    <div class="stat-icon">
                        <i class="bi bi-shield-exclamation"></i>
                    </div>
                    <div class="stat-value" id="blockedCount">0</div>
                    <div class="stat-label">IPs Blocked</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card stat-card card-uptime text-white">
                    <div class="stat-icon">
                        <i class="bi bi-activity"></i>
                    </div>
                    <div class="stat-value" id="systemStatus">
                        <span id="status-indicator"></span>
                        <span id="connection-status">Connected</span>
                    </div>
                    <div class="stat-label">System Status</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Network Traffic</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trafficChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Threat Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="threatDistribution"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Event Monitor</h5>
                    </div>
                    <div class="card-body">
                        <div class="toolbar mb-3">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="search-container">
                                        <i class="bi bi-search"></i>
                                        <input type="text" id="filterInput" class="form-control search-input" placeholder="Search events...">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="filter-tags">
                                        <span class="filter-tag active" data-category="all">All</span>
                                        <span class="filter-tag" data-category="ip">IP Events</span>
                                        <span class="filter-tag" data-category="port">Port Scans</span>
                                        <span class="filter-tag" data-category="dns">DNS Queries</span>
                                        <span class="filter-tag" data-category="error">Errors</span>
                                        <span class="filter-tag" data-category="warning">Warnings</span>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <div class="btn-group">
                                        <button class="btn btn-outline-secondary" id="clearEvents">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <button class="btn btn-outline-primary" id="exportEvents">
                                            <i class="bi bi-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="events-container" class="mb-4">
                            <!-- Events will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventsContainer = document.getElementById('events-container');
        let statusIndicator = document.getElementById('status-indicator');
        let connectionStatus = document.getElementById('connection-status');
        let filterInput = document.getElementById('filterInput');
        let eventSource = null;
        let maxEvents = 100;

        function connectEventSource() {
            // Reset counters on new connection
            document.getElementById('packetCount').innerText = '0';
            document.getElementById('threatCount').innerText = '0';
            
            eventSource = new EventSource('/events');
            
            eventSource.onopen = function() {
                statusIndicator.className = 'status-connected';
                connectionStatus.textContent = 'Connected';
            };

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                addEvent(data.message);
            };

            eventSource.onerror = function() {
                statusIndicator.className = 'status-disconnected';
                connectionStatus.textContent = 'Disconnected - Reconnecting...';
                eventSource.close();
                setTimeout(connectEventSource, 5000);
            };

            // Get current configuration to update blocked IPs count
            fetch('/api/config', {
                credentials: 'include'  // Include credentials in the request
            })
                .then(response => response.json())
                .then(config => {
                    console.log('Fetched config:', config.IP_RULES.BLACKLISTED_IPS);
                    if (config.IP_RULES.BLACKLISTED_IPS) {
                        document.getElementById('blockedCount').innerText = config.IP_RULES.BLACKLISTED_IPS.length;
                    }
                })
                .catch(error => console.error('Error fetching config:', error));
        }

        function addEvent(message) {
            const card = document.createElement('div');
            card.className = 'card event-card';
            
            // Determine event category and add appropriate class
            if (message.includes('IP')) {
                card.classList.add('event-ip');
            } else if (message.includes('Port')) {
                card.classList.add('event-port');
            } else if (message.includes('DNS')) {
                card.classList.add('event-dns');
            } else if (message.toLowerCase().includes('warning')) {
                card.classList.add('event-warning');
            } else if (message.toLowerCase().includes('error')) {
                card.classList.add('event-error');
            } else {
                card.classList.add('event-info');
            }

            // Extract timestamp and category
            const timestamp = new Date().toLocaleTimeString();
            let category = 'INFO';
            if (card.classList.contains('event-ip')) category = 'IP';
            if (card.classList.contains('event-port')) category = 'PORT';
            if (card.classList.contains('event-dns')) category = 'DNS';
            if (card.classList.contains('event-warning')) category = 'WARNING';
            if (card.classList.contains('event-error')) category = 'ERROR';

            card.innerHTML = `
                <div class="card-body">
                    <span class="category-badge badge bg-secondary">${category}</span>
                    <small class="text-muted">${timestamp}</small>
                    <p class="card-text mb-0">${message}</p>
                </div>
            `;

            eventsContainer.insertBefore(card, eventsContainer.firstChild);
            if (eventsContainer.children.length > maxEvents) {
                eventsContainer.removeChild(eventsContainer.lastChild);
            }
        }

        // Enhanced filtering system
        const filterTags = document.querySelectorAll('.filter-tag');
        let activeFilters = ['all'];

        filterTags.forEach(tag => {
            tag.addEventListener('click', () => {
                const category = tag.dataset.category;
                
                if (category === 'all') {
                    activeFilters = ['all'];
                    filterTags.forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                } else {
                    const allTag = document.querySelector('.filter-tag[data-category="all"]');
                    allTag.classList.remove('active');
                    
                    tag.classList.toggle('active');
                    if (tag.classList.contains('active')) {
                        activeFilters = activeFilters.filter(f => f !== 'all');
                        activeFilters.push(category);
                    } else {
                        activeFilters = activeFilters.filter(f => f !== category);
                    }
                    
                    if (activeFilters.length === 0) {
                        activeFilters = ['all'];
                        allTag.classList.add('active');
                    }
                }
                
                applyFilters();
            });
        });

        function applyFilters() {
            const searchText = filterInput.value.toLowerCase();
            Array.from(eventsContainer.children).forEach(card => {
                const cardText = card.textContent.toLowerCase();
                const cardCategory = getCardCategory(card);
                
                const matchesSearch = cardText.includes(searchText);
                const matchesCategory = activeFilters.includes('all') || 
                                     activeFilters.some(filter => cardCategory.includes(filter.toLowerCase()));
                
                card.style.display = matchesSearch && matchesCategory ? '' : 'none';
            });
        }

        function getCardCategory(card) {
            if (card.classList.contains('event-ip')) return 'ip';
            if (card.classList.contains('event-port')) return 'port';
            if (card.classList.contains('event-dns')) return 'dns';
            if (card.classList.contains('event-warning')) return 'warning';
            if (card.classList.contains('event-error')) return 'error';
            return 'info';
        }

        // Export functionality
        document.getElementById('exportEvents').addEventListener('click', () => {
            const events = Array.from(eventsContainer.children)
                .filter(card => card.style.display !== 'none')
                .map(card => {
                    const timestamp = card.querySelector('small').textContent;
                    const category = card.querySelector('.category-badge').textContent;
                    const message = card.querySelector('.card-text').textContent;
                    return `${timestamp},${category},"${message}"`;
                });
            
            const csv = ['Timestamp,Category,Message', ...events].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `network_events_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        filterInput.addEventListener('input', applyFilters);

        // Initialize charts
        const trafficCtx = document.getElementById('trafficChart').getContext('2d');
        const threatDistributionCtx = document.getElementById('threatDistribution').getContext('2d');

        // Traffic Chart
        const trafficChart = new Chart(trafficCtx, {
            type: 'line',
            data: {
                labels: Array(60).fill(''),
                datasets: [{
                    label: 'Packets/s',
                    data: Array(60).fill(0),
                    borderColor: '#2196f3',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(33, 150, 243, 0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0 // Disable animation for better performance
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Packets/second'
                        }
                    },
                    x: {
                        display: false // Hide x-axis labels for cleaner look
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Initialize packet counter and timestamp for rate calculation
        let lastUpdateTime = Date.now();
        let packetsSinceLastUpdate = 0;

        function updateTrafficChart() {
            const now = Date.now();
            const timeDiff = (now - lastUpdateTime) / 1000; // Convert to seconds
            
            if (timeDiff >= 1) { // Update every second
                const packetsPerSecond = Math.round(packetsSinceLastUpdate / timeDiff);
                
                // Shift data array and add new value
                trafficChart.data.datasets[0].data.shift();
                trafficChart.data.datasets[0].data.push(packetsPerSecond);
                
                // Update chart
                trafficChart.update('none'); // Use 'none' mode for better performance
                
                // Reset counters
                packetsSinceLastUpdate = 0;
                lastUpdateTime = now;
            }
        }

        // Set up interval to update chart
        setInterval(updateTrafficChart, 1000);

        // Initialize Threat Distribution Chart
        const threatDistributionChart = new Chart(threatDistributionCtx, {
            type: 'doughnut',
            data: {
                labels: ['IP', 'Port', 'DNS', 'Other'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        '#2962ff',  // Blue for IP
                        '#2e7d32',  // Green for Port
                        '#6f42c1',  // Purple for DNS
                        '#ed6c02'   // Orange for Other
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                return `${context.label}: ${context.raw} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        let stats = {
            threats: 0,
            packets: 0,
            blockedIPs: new Set(),
            threatTypes: {
                ip: 0,
                port: 0,
                dns: 0,
                other: 0
            },
            uniqueIPs: new Set()
        };

        function updateStats(message) {
            // Parse the message
            let logMatch = message.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) - (\w+) - (.+)$/);
            if (!logMatch) return;

            let [_, timestamp, level, content] = logMatch;
            
            // Update threat count for alerts
            if (level === 'WARNING' || level === 'ALERT') {
                let threatCount = parseInt(document.getElementById('threatCount').innerText);
                document.getElementById('threatCount').innerText = threatCount + 1;

                // Update IPs blocked counter when blacklisted IP is detected
                // if (content.includes('blacklisted IP')) {
                //     let blockedCount = parseInt(document.getElementById('blockedCount').innerText);
                //     document.getElementById('blockedCount').innerText = blockedCount + 1;
                // }

                // Update threat distribution chart
                let threatIndex = 3; // Default to Other (index 3)
                if (content.includes('blacklisted IP')) {
                    threatIndex = 0; // IP threats
                } else if (content.includes('port scan') || content.includes('Suspicious port')) {
                    threatIndex = 1; // Port threats
                } else if (content.includes('DNS') || content.includes('domain')) {
                    threatIndex = 2; // DNS threats
                }

                // Update the chart data
                threatDistributionChart.data.datasets[0].data[threatIndex]++;
                threatDistributionChart.update();
            }

            // Update packet count for all messages
            let packetCount = parseInt(document.getElementById('packetCount').innerText);
            document.getElementById('packetCount').innerText = packetCount + 1;
            
            // Increment packet counter for traffic chart
            packetsSinceLastUpdate++;
        }

        // Modify existing addEvent function to update stats
        const originalAddEvent = addEvent;
        addEvent = function(message) {
            originalAddEvent(message);
            updateStats(message);
        };

        // Start connection
        connectEventSource();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
